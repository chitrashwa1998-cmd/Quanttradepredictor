<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribexAlpha - Quantitative Trading Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/esm/index.js" type="module"></script>
    <script src="https://unpkg.com/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://unpkg.com/moment@2.29.4/moment.js"></script>
    <link href="https://unpkg.com/antd@5.12.0/dist/reset.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .metric-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        
        .button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .button.primary {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .market-open {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
        }
        
        .market-closed {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .alert {
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            color: #f39c12;
        }
        
        .chart-container {
            height: 300px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            padding: 15px;
        }
        
        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .prediction-card {
            background: rgba(142, 68, 173, 0.1);
            border: 1px solid rgba(142, 68, 173, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .prediction-label {
            font-size: 0.9rem;
            color: #8e44ad;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .prediction-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .confidence-bar {
            width: 100%;
            height: 6px;
            background: rgba(142, 68, 173, 0.2);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Indian Standard Time utility
        const getISTTime = () => {
            const now = new Date();
            const istOffset = 5.5 * 60; // IST is UTC+5:30
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const ist = new Date(utc + (istOffset * 60000));
            return ist;
        };

        // Market hours checker
        const isMarketOpen = () => {
            const ist = getISTTime();
            const hour = ist.getHours();
            const minute = ist.getMinutes();
            const day = ist.getDay(); // 0 = Sunday, 6 = Saturday
            
            // Market open: Monday-Friday, 9:15 AM - 3:30 PM IST
            const isWeekday = day >= 1 && day <= 5;
            const isMarketHours = (hour > 9 || (hour === 9 && minute >= 15)) && 
                                 (hour < 15 || (hour === 15 && minute <= 30));
            
            return isWeekday && isMarketHours;
        };

        // Real API calls to Python backend
        const fetchNiftyData = async () => {
            try {
                const response = await fetch('/api/nifty-data');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.success ? data.data : null;
            } catch (error) {
                console.error('Failed to fetch Nifty data:', error);
                // Return fallback structure to prevent UI crashes
                return {
                    price: 0,
                    change: 0,
                    changePercent: 0,
                    volume: 0,
                    high: 0,
                    low: 0,
                    open: 0
                };
            }
        };

        const fetchPredictions = async () => {
            try {
                const response = await fetch('/api/predictions');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.success ? data.data : null;
            } catch (error) {
                console.error('Failed to fetch predictions:', error);
                // Return fallback structure to prevent UI crashes
                return {
                    direction: 'UNKNOWN',
                    directionConfidence: 0.5,
                    priceTarget: 0,
                    targetConfidence: 0.5,
                    trend: 'UNKNOWN',
                    trendConfidence: 0.5,
                    volatility: 'MEDIUM'
                };
            }
        };

        // Main Dashboard Component
        const TradingDashboard = () => {
            const [currentTime, setCurrentTime] = useState(getISTTime());
            const [marketOpen, setMarketOpen] = useState(isMarketOpen());
            const [niftyData, setNiftyData] = useState(null);
            const [predictions, setPredictions] = useState(null);
            const [loading, setLoading] = useState(true);
            const [autoRefresh, setAutoRefresh] = useState(true);
            const [lastUpdate, setLastUpdate] = useState(null);

            // Update time every second
            useEffect(() => {
                const timer = setInterval(() => {
                    const newTime = getISTTime();
                    setCurrentTime(newTime);
                    setMarketOpen(isMarketOpen());
                }, 1000);

                return () => clearInterval(timer);
            }, []);

            // Auto-refresh data every 30 seconds during market hours
            useEffect(() => {
                const refreshData = async () => {
                    if (autoRefresh && marketOpen) {
                        setLoading(true);
                        try {
                            const [nifty, pred] = await Promise.all([
                                fetchNiftyData(),
                                fetchPredictions()
                            ]);
                            setNiftyData(nifty);
                            setPredictions(pred);
                            setLastUpdate(new Date());
                        } catch (error) {
                            console.error('Failed to fetch data:', error);
                        }
                        setLoading(false);
                    }
                };

                // Initial load
                refreshData();

                // Set up auto-refresh
                const interval = setInterval(refreshData, 30000);
                return () => clearInterval(interval);
            }, [autoRefresh, marketOpen]);

            const handleManualRefresh = async () => {
                setLoading(true);
                try {
                    const [nifty, pred] = await Promise.all([
                        fetchNiftyData(),
                        fetchPredictions()
                    ]);
                    setNiftyData(nifty);
                    setPredictions(pred);
                    setLastUpdate(new Date());
                } catch (error) {
                    console.error('Failed to fetch data:', error);
                }
                setLoading(false);
            };

            return (
                <div className="container">
                    {/* Header */}
                    <div className="header">
                        <h1>
                            <i className="fas fa-chart-line"></i>
                            TribexAlpha Trading Dashboard
                        </h1>
                        <p>Quantitative Trading System for Nifty 50 Index</p>
                        
                        <div style={{marginTop: '15px', display: 'flex', alignItems: 'center', gap: '20px', flexWrap: 'wrap'}}>
                            <div>
                                <strong>Current Time (IST):</strong> {currentTime.toLocaleTimeString('en-IN')}
                            </div>
                            <div className={`status-indicator ${marketOpen ? 'market-open' : 'market-closed'}`}>
                                <i className={`fas ${marketOpen ? 'fa-circle' : 'fa-pause-circle'}`}></i>
                                {marketOpen ? 'Market Open' : 'Market Closed'}
                            </div>
                            {lastUpdate && (
                                <div>
                                    <strong>Last Update:</strong> {lastUpdate.toLocaleTimeString('en-IN')}
                                </div>
                            )}
                        </div>
                        
                        <div style={{marginTop: '15px'}}>
                            <button className="button primary" onClick={handleManualRefresh} disabled={loading}>
                                <i className="fas fa-sync-alt"></i> {loading ? 'Updating...' : 'Refresh Data'}
                            </button>
                            <button 
                                className="button" 
                                onClick={() => setAutoRefresh(!autoRefresh)}
                                style={{background: autoRefresh ? '#27ae60' : '#95a5a6'}}
                            >
                                <i className={`fas ${autoRefresh ? 'fa-pause' : 'fa-play'}`}></i>
                                {autoRefresh ? 'Pause Auto-Refresh' : 'Enable Auto-Refresh'}
                            </button>
                        </div>
                    </div>

                    {/* Dashboard Grid */}
                    <div className="dashboard-grid">
                        {/* Real-time Market Data */}
                        <div className="card">
                            <h3>
                                <i className="fas fa-chart-area"></i>
                                Nifty 50 Real-time Data
                            </h3>
                            {niftyData ? (
                                <div className="metric-grid">
                                    <div className="metric">
                                        <div className="metric-label">Current Price</div>
                                        <div className="metric-value">₹{niftyData.price.toFixed(2)}</div>
                                        <div className={`metric-change ${niftyData.change >= 0 ? 'positive' : 'negative'}`}>
                                            {niftyData.change >= 0 ? '+' : ''}{niftyData.change.toFixed(2)} 
                                            ({niftyData.changePercent >= 0 ? '+' : ''}{niftyData.changePercent.toFixed(2)}%)
                                        </div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-label">Volume</div>
                                        <div className="metric-value">{(niftyData.volume / 1000).toFixed(0)}K</div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-label">High</div>
                                        <div className="metric-value">₹{niftyData.high.toFixed(2)}</div>
                                    </div>
                                    <div className="metric">
                                        <div className="metric-label">Low</div>
                                        <div className="metric-value">₹{niftyData.low.toFixed(2)}</div>
                                    </div>
                                </div>
                            ) : (
                                <div style={{textAlign: 'center', padding: '20px'}}>
                                    <i className="fas fa-spinner fa-spin"></i> Loading market data...
                                </div>
                            )}
                        </div>

                        {/* AI Predictions */}
                        <div className="card">
                            <h3>
                                <i className="fas fa-brain"></i>
                                AI Model Predictions
                            </h3>
                            {predictions ? (
                                <div className="predictions-grid">
                                    <div className="prediction-card">
                                        <div className="prediction-label">Direction</div>
                                        <div className={`prediction-value ${predictions.direction === 'UP' ? 'positive' : 'negative'}`}>
                                            <i className={`fas ${predictions.direction === 'UP' ? 'fa-arrow-up' : 'fa-arrow-down'}`}></i>
                                            {predictions.direction}
                                        </div>
                                        <div className="confidence-bar">
                                            <div className="confidence-fill" style={{width: `${predictions.directionConfidence * 100}%`}}></div>
                                        </div>
                                        <div style={{fontSize: '0.8rem', marginTop: '5px'}}>
                                            {(predictions.directionConfidence * 100).toFixed(1)}% confidence
                                        </div>
                                    </div>
                                    
                                    <div className="prediction-card">
                                        <div className="prediction-label">Price Target</div>
                                        <div className="prediction-value">₹{predictions.priceTarget.toFixed(0)}</div>
                                        <div className="confidence-bar">
                                            <div className="confidence-fill" style={{width: `${predictions.targetConfidence * 100}%`}}></div>
                                        </div>
                                        <div style={{fontSize: '0.8rem', marginTop: '5px'}}>
                                            {(predictions.targetConfidence * 100).toFixed(1)}% confidence
                                        </div>
                                    </div>
                                    
                                    <div className="prediction-card">
                                        <div className="prediction-label">Trend</div>
                                        <div className="prediction-value">{predictions.trend}</div>
                                        <div className="confidence-bar">
                                            <div className="confidence-fill" style={{width: `${predictions.trendConfidence * 100}%`}}></div>
                                        </div>
                                        <div style={{fontSize: '0.8rem', marginTop: '5px'}}>
                                            {(predictions.trendConfidence * 100).toFixed(1)}% confidence
                                        </div>
                                    </div>
                                    
                                    <div className="prediction-card">
                                        <div className="prediction-label">Volatility</div>
                                        <div className="prediction-value">{predictions.volatility}</div>
                                    </div>
                                </div>
                            ) : (
                                <div style={{textAlign: 'center', padding: '20px'}}>
                                    <i className="fas fa-spinner fa-spin"></i> Loading predictions...
                                </div>
                            )}
                        </div>

                        {/* Trading Alerts */}
                        <div className="card">
                            <h3>
                                <i className="fas fa-bell"></i>
                                Trading Alerts
                            </h3>
                            {marketOpen ? (
                                <div>
                                    {niftyData && predictions && (
                                        <div>
                                            {Math.abs(niftyData.changePercent) > 0.5 && (
                                                <div className="alert">
                                                    <i className="fas fa-exclamation-triangle"></i>
                                                    Sharp price movement: {niftyData.changePercent.toFixed(2)}% today
                                                </div>
                                            )}
                                            {predictions.volatility === 'HIGH' && (
                                                <div className="alert">
                                                    <i className="fas fa-chart-line"></i>
                                                    High volatility detected - Exercise caution
                                                </div>
                                            )}
                                            {predictions.directionConfidence > 0.8 && (
                                                <div className="alert">
                                                    <i className="fas fa-target"></i>
                                                    Strong {predictions.direction} signal with {(predictions.directionConfidence * 100).toFixed(0)}% confidence
                                                </div>
                                            )}
                                            {Math.abs(niftyData.changePercent) < 0.2 && (
                                                <div style={{color: '#27ae60', padding: '10px', textAlign: 'center'}}>
                                                    <i className="fas fa-check-circle"></i>
                                                    No significant alerts - Normal market conditions
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div style={{textAlign: 'center', padding: '20px', color: '#7f8c8d'}}>
                                    <i className="fas fa-moon"></i>
                                    <br />
                                    Market is closed. Alerts will resume during trading hours.
                                </div>
                            )}
                        </div>

                        {/* System Status */}
                        <div className="card">
                            <h3>
                                <i className="fas fa-server"></i>
                                System Status
                            </h3>
                            <div className="metric-grid">
                                <div className="metric">
                                    <div className="metric-label">Data Source</div>
                                    <div className="metric-value" style={{fontSize: '1rem', color: '#27ae60'}}>
                                        <i className="fas fa-check-circle"></i> Active
                                    </div>
                                </div>
                                <div className="metric">
                                    <div className="metric-label">AI Models</div>
                                    <div className="metric-value" style={{fontSize: '1rem', color: '#27ae60'}}>
                                        <i className="fas fa-check-circle"></i> Online
                                    </div>
                                </div>
                                <div className="metric">
                                    <div className="metric-label">Auto-Refresh</div>
                                    <div className="metric-value" style={{fontSize: '1rem', color: autoRefresh ? '#27ae60' : '#e74c3c'}}>
                                        <i className={`fas ${autoRefresh ? 'fa-play-circle' : 'fa-pause-circle'}`}></i>
                                        {autoRefresh ? 'Enabled' : 'Disabled'}
                                    </div>
                                </div>
                                <div className="metric">
                                    <div className="metric-label">Update Frequency</div>
                                    <div className="metric-value" style={{fontSize: '0.9rem'}}>30 seconds</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the application using React 18 createRoot
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingDashboard />);
    </script>
</body>
</html>